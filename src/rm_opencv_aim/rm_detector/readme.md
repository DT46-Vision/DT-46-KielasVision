â¸»


# rm_detector â€” Armor Detector with OpenCV + PnP

## ğŸ“Œ ç®€ä»‹
æœ¬åŒ…å®ç°äº†åŸºäº **OpenCV** å’Œ **PnP è§£ç®—** çš„è£…ç”²æ¿æ£€æµ‹ä¸å§¿æ€ä¼°è®¡ï¼Œæ”¯æŒé«˜å¸§ç‡è¿è¡Œï¼ˆ>700 FPSï¼‰ã€‚  
é‡‡ç”¨ **ROS 2 (Humble)**ï¼Œé€šè¿‡ç‹¬ç«‹çº¿ç¨‹å®ç°å›¾åƒå¤„ç†ä¸ ROS é€šä¿¡è§£è€¦ã€‚  

---

## âš¡ åŠŸèƒ½ç‰¹æ€§
- **é«˜å¸§ç‡æ£€æµ‹**ï¼šç‹¬ç«‹çº¿ç¨‹è§£è€¦è®¢é˜…ä¸å¤„ç†ï¼Œæ”¯æŒ >700 FPSã€‚
- **é›¶æ‹·è´ä¼˜åŒ–**ï¼šä½¿ç”¨ `cv_bridge::toCvShare` é¿å…ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶ã€‚
- **å…‰å¿ƒæ ¡æ­£**ï¼šå¯é€‰æ‹©ä½¿ç”¨æ ‡å®šå…‰å¿ƒæˆ–å›¾åƒå‡ ä½•ä¸­å¿ƒã€‚
- **å‚æ•°å¯è°ƒ**ï¼šæ”¯æŒåŠ¨æ€å‚æ•°è°ƒæ•´ï¼ˆ`rqt_reconfigure` æˆ– `ros2 param set`ï¼‰ã€‚
- **å¯è§†åŒ–**ï¼šå‘å¸ƒäºŒå€¼åŒ–å›¾åƒ `/detector/bin_img` ä¸æ ‡æ³¨ç»“æœ `/detector/armors_img`ã€‚
- **æ—¥å¿—ä¼˜åŒ–**ï¼šå…³é”®æ—¥å¿—ä¿ç•™ï¼Œå†—ä½™æ—¥å¿—èŠ‚æµã€‚

---

## ğŸ›  å‚æ•°è¯´æ˜

| å‚æ•°å                  | ç±»å‹   | é»˜è®¤å€¼ | è¯´æ˜ |
|--------------------------|--------|--------|------|
| `light_area_min`         | int    | 5      | ç¯æ¡æœ€å°é¢ç§¯ |
| `light_angle_min`        | int    | -35    | ç¯æ¡æœ€å°è§’åº¦ |
| `light_angle_max`        | int    | 35     | ç¯æ¡æœ€å¤§è§’åº¦ |
| `light_red_ratio`        | float  | 2.0    | çº¢è‰²é€šé“æ¯”ä¾‹é˜ˆå€¼ |
| `light_blue_ratio`       | float  | 2.0    | è“è‰²é€šé“æ¯”ä¾‹é˜ˆå€¼ |
| `cy_tol`                 | int    | 5      | y åæ ‡å®¹å·® |
| `height_rate_tol`        | float  | 1.3    | é«˜åº¦æ¯”ä¾‹å®¹å·® |
| `vertical_discretization`| float  | 1.5    | å‚ç›´ç¦»æ•£åŒ–é˜ˆå€¼ |
| `height_multiplier_min`  | float  | 1.8    | é«˜åº¦ç¼©æ”¾æœ€å°å€¼ |
| `height_multiplier_max`  | float  | 3.0    | é«˜åº¦ç¼©æ”¾æœ€å¤§å€¼ |
| `binary_val`             | int    | 20     | äºŒå€¼åŒ–é˜ˆå€¼ |
| `detect_color`           | int    | 2      | æ£€æµ‹é¢œè‰²ï¼ˆ1=çº¢ï¼Œ2=è“ï¼‰ |
| `display_mode`           | int    | 0      | æ˜¾ç¤ºæ¨¡å¼ï¼ˆ0=ä¸æ˜¾ç¤ºï¼Œ1=éƒ¨åˆ†æ˜¾ç¤ºï¼Œ2=è°ƒè¯•æ˜¾ç¤ºï¼‰ |
| `camera_id`              | int    | 1      | ç›¸æœºç¼–å· |
| `use_geometric_center`   | bool   | true   | æ˜¯å¦ç”¨å›¾åƒå‡ ä½•ä¸­å¿ƒä»£æ›¿æ ‡å®šå…‰å¿ƒ |
| `max_processing_fps`     | int    | 0      | æœ€å¤§å¤„ç†å¸§ç‡é™åˆ¶ï¼ˆ0=ä¸é™é€Ÿï¼‰ |

---

## ğŸš€ è¿è¡Œ

### å¯åŠ¨èŠ‚ç‚¹
```bash
ros2 run rm_detector armor_detector_opencv_node

å¸¸ç”¨è°ƒå‚

ros2 param set /armor_detector_opencv_node detect_color 1
ros2 param set /armor_detector_opencv_node display_mode 2
ros2 param set /armor_detector_opencv_node use_geometric_center true


â¸»

ğŸ“¡ è¯é¢˜æ¥å£

è®¢é˜…
	â€¢	/image_raw (sensor_msgs/msg/Image)
è¾“å…¥ç›¸æœºå›¾åƒ
	â€¢	/camera_info (sensor_msgs/msg/CameraInfo)
ç›¸æœºæ ‡å®šå‚æ•°

å‘å¸ƒ
	â€¢	/detector/armors_info (rm_interfaces/msg/ArmorsCppMsg)
è£…ç”²æ¿ä½å§¿ä¿¡æ¯ï¼ˆyaw, pitch, deepï¼‰
	â€¢	/detector/armors_img (sensor_msgs/msg/Image)
ç»˜åˆ¶è£…ç”²æ¿çš„è°ƒè¯•å›¾åƒ
	â€¢	/detector/bin_img (sensor_msgs/msg/Image)
äºŒå€¼åŒ–å›¾åƒ

â¸»

ğŸ”§ Debug ç»éªŒæ€»ç»“

1. å…‰å¿ƒåå·®
	â€¢	é—®é¢˜ï¼šæ ‡å®šå…‰å¿ƒ (cx, cy) ä¸å›¾åƒå‡ ä½•ä¸­å¿ƒä¸ä¸€è‡´ï¼Œyaw/pitch åç§»ã€‚
	â€¢	è§£å†³ï¼šåŠ å…¥ use_geometric_center å‚æ•°ï¼Œå…è®¸ç”¨å‡ ä½•ä¸­å¿ƒæ›¿ä»£å…‰å¿ƒã€‚

2. æ—¥å¿—è¿‡å¤š
	â€¢	é—®é¢˜ï¼šRCLCPP_INFO é«˜é¢‘è¾“å‡ºæ‹–æ…¢æ€§èƒ½ã€‚
	â€¢	è§£å†³ï¼šæ”¹ç”¨ RCLCPP_INFO_THROTTLEï¼Œä¿ç•™å…³é”®ä¿¡æ¯ã€‚

3. å¸§ç‡ä½ï¼ˆä¸å¼€ GUIï¼‰
	â€¢	é—®é¢˜ï¼šä¸å¼€ rqt æ˜¾ç¤ºæ—¶ï¼ŒFPS æ‰åˆ° ~80ã€‚
	â€¢	åŸå› ï¼šDDS ç¼“å†²ç§¯å‹ï¼Œç”Ÿäº§è€…é™é€Ÿã€‚
	â€¢	è§£å†³ï¼šä½¿ç”¨ SensorDataQoS + ç‹¬ç«‹çº¿ç¨‹ç¼“å­˜æœ€æ–°å¸§ï¼Œé¿å…å»¶è¿Ÿã€‚

4. OpenCL åŠ é€Ÿ
	â€¢	é—®é¢˜ï¼šå°è¯• cv::ocl æŠ¥é”™ï¼ˆæœªå¯ç”¨ OpenCLï¼‰ã€‚
	â€¢	è§£å†³ï¼šå»æ‰ OpenCLï¼ŒåŠ é€Ÿæ„ä¹‰ä¸å¤§ã€‚

5. FPS ç»Ÿè®¡
	â€¢	ä¼˜åŒ–ï¼šä»…ç»Ÿè®¡å¤„ç†å¸§ç‡ï¼ˆprocessed FPSï¼‰ï¼Œæ¯ç§’ WARN æ‰“å°ä¸€æ¬¡ã€‚

â¸»

ğŸ“ˆ æ€§èƒ½ç»“æœ
	â€¢	æ—§ç‰ˆæœ¬ï¼šä¸å¼€ GUI æ—¶ ~80 FPSï¼Œå¼€ GUI æ—¶ ~150 FPSã€‚
	â€¢	æ”¹è¿›åï¼šç¨³å®š 700~900 FPSï¼ŒCPU åˆ©ç”¨ç‡åˆç†ã€‚

â¸»

âœ¨ TODO
	â€¢	æ”¯æŒ TensorRT åŠ é€Ÿæ£€æµ‹
	â€¢	å¤šç›¸æœºåŒæ­¥å¤„ç†
	â€¢	æ·±åº¦ä¿¡æ¯èåˆï¼ˆæ¿€å…‰æµ‹è· / æ·±åº¦ç›¸æœºï¼‰

â¸»


---
